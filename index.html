<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>US POS - Mobile System</title>
    
    <!-- 1. Tailwind CSS with Config for Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            750: '#2d3748', 
                            850: '#1a202c',
                            950: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .cart-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0;
            }
            .no-print { display: none !important; }
            .print-border { border: 1px solid #ddd !important; }
            ::-webkit-scrollbar { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 h-screen overflow-hidden transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- System Info ---
        const APP_VERSION = "1.0.17";
        const LAST_UPDATE = "22/12/2025";

        // --- Initial Data ---
        const INITIAL_STOCK = [
            { id: 1, productId: 'P-0001', group: 'อุปกรณ์เสริม', name: 'Film U&i', qty: 10, cost: 19, price: 100 },
            { id: 2, productId: 'P-0002', group: 'อุปกรณ์เสริม', name: 'Film Focus', qty: 5, cost: 120, price: 350 },
            { id: 3, productId: 'P-0003', group: 'อุปกรณ์เสริม', name: 'ชุดชาร์จ micro', qty: 8, cost: 30, price: 250 },
            { id: 5, productId: 'MOB001', group: 'โทรศัพท์', name: 'A36 5G', qty: 2, cost: 9100, price: 11500 },
            { id: 7, productId: 'SIM001', group: 'ซิมการ์ด', name: 'Sim OTC', qty: 20, cost: 29, price: 50 },
        ];
        const INITIAL_CATEGORIES = ['ทั่วไป', 'โทรศัพท์', 'อุปกรณ์เสริม', 'ซิมการ์ด', 'บริการ'];
        const INITIAL_USERS = [
            { id: 1, name: 'เจ้าของร้าน', username: 'admin', password: '1234', role: 'admin', permissions: ['all'] },
            { id: 2, name: 'พนักงานขาย', username: 'staff', password: '1234', role: 'staff', permissions: ['pos', 'services', 'report'] }
        ];

        const PERMISSION_LABELS = {
            'pos': 'ขายหน้าร้าน', 'services': 'บริการ', 'installments': 'ฝากผ่อน',
            'stock': 'จัดการสต็อก', 'report': 'รายงาน', 'users': 'จัดการผู้ใช้', 'audit': 'ประวัติการใช้งาน'
        };

        // --- Helper Functions ---
        const parseNum = (val) => {
            if (!val || val === '') return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        };

        const getSafeDate = (dateStr) => {
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? new Date() : date;
        };

        // --- Icons ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Icons = {
            Smartphone: () => <Icon><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></Icon>,
            CreditCard: () => <Icon><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></Icon>,
            Wrench: () => <Icon><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></Icon>,
            Wifi: () => <Icon><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></Icon>,
            Package: () => <Icon><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></Icon>,
            BarChart3: () => <Icon><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Icon>,
            Search: () => <Icon><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>,
            ShoppingCart: () => <Icon><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></Icon>,
            Plus: () => <Icon><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Trash2: () => <Icon><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
            Edit: () => <Icon><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            User: () => <Icon><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            ArrowRightLeft: () => <Icon><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></Icon>,
            Check: () => <Icon><polyline points="20 6 9 17 4 12"/></Icon>,
            Filter: () => <Icon><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>,
            ChevronUp: () => <Icon><polyline points="18 15 12 9 6 15"/></Icon>,
            ChevronDown: () => <Icon><polyline points="6 9 12 15 18 9"/></Icon>,
            ScanBarcode: () => <Icon><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 7v10"/><path d="M12 7v10"/><path d="M17 7v10"/></Icon>,
            Menu: () => <Icon><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Icon>,
            Download: () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
            Upload: () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>,
            AlertCircle: () => <Icon><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>,
            FileText: () => <Icon><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></Icon>,
            Printer: () => <Icon><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></Icon>,
            Database: () => <Icon><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>,
            X: () => <Icon><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Users: () => <Icon><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>,
            LogOut: () => <Icon><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>,
            Shield: () => <Icon><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></Icon>,
            Settings: () => <Icon><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Sheet: () => <Icon><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Box: () => <Icon><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></Icon>,
            History: () => <Icon><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></Icon>,
            QrCode: () => <Icon><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></Icon>,
            Camera: () => <Icon><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>,
            Clock: () => <Icon><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
            Sun: () => <Icon><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></Icon>,
            Moon: () => <Icon><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></Icon>
        };

        // --- UI Components ---
        const Card = ({ children, className = "", id="" }) => <div id={id} className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 ${className}`}>{children}</div>;
        const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false, title = "", type = "button" }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md",
                secondary: "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600",
                danger: "bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50",
                warning: "bg-orange-500 text-white hover:bg-orange-600 shadow-orange-200",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-green-200",
                outline: "border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700"
            };
            return <button type={type} onClick={onClick} disabled={disabled} title={title} className={`px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>{children}</button>;
        };

        const Modal = ({ title, onClose, children, maxWidth = "max-w-md", id="" }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                <Card className={`w-full ${maxWidth} overflow-hidden flex flex-col max-h-[90vh] shadow-2xl dark:shadow-slate-900/50`} id={id}>
                    <div className="p-4 border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-850 font-bold text-lg flex justify-between items-center text-slate-800 dark:text-white no-print">
                        <span>{title}</span>
                        <button onClick={onClose} className="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full text-slate-500 dark:text-slate-400"><Icons.X /></button>
                    </div>
                    <div className="p-6 overflow-y-auto">{children}</div>
                </Card>
            </div>
        );

        const ConfirmModal = ({ title, message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                <Card className="w-full max-sm overflow-hidden shadow-2xl p-6 text-center">
                    <Icons.AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-2">{title}</h3>
                    <p className="text-slate-500 dark:text-slate-400 mb-6">{message}</p>
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={onCancel} className="flex-1">ยกเลิก</Button>
                        <Button variant="danger" onClick={onConfirm} className="flex-1">ยืนยัน</Button>
                    </div>
                </Card>
            </div>
        );

        const Notification = ({ message, type = 'success', onClose }) => (
            <div className={`fixed top-4 right-4 z-[70] px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 fade-in ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                {type === 'success' ? <Icons.Check /> : <Icons.AlertCircle />}<span className="font-medium">{message}</span><button onClick={onClose} className="ml-2 hover:bg-white/20 rounded-full p-1"><Icons.X /></button>
            </div>
        );

        // --- Login Screen ---
        const LoginScreen = ({ onLogin, isDarkMode, toggleTheme }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onLogin(username, password); };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 p-4 relative transition-colors duration-300">
                    <Card className="w-full max-w-sm p-8 shadow-xl relative z-10 dark:shadow-slate-950/50">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400">
                                <Icons.Smartphone className="w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">เข้าสู่ระบบ</h1>
                            <p className="text-slate-500 dark:text-slate-400 text-sm">US POS System</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ชื่อผู้ใช้</label>
                                <input type="text" className="w-full p-3 border dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700 dark:text-white transition-colors" value={username} onChange={e => setUsername(e.target.value)} autoFocus />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">รหัสผ่าน</label>
                                <input type="password" className="w-full p-3 border dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700 dark:text-white transition-colors" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <Button type="submit" className="w-full py-3 text-lg">เข้าสู่ระบบ</Button>
                        </form>
                    </Card>
                    <div className="absolute bottom-4 right-4 flex flex-col items-end gap-2">
                        <button 
                            onClick={toggleTheme}
                            className="bg-white dark:bg-slate-800 p-2 rounded-full shadow-lg border dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all active:scale-95 flex items-center gap-2 px-3 mb-1"
                        >
                            {isDarkMode ? <Icons.Sun className="w-4 h-4" /> : <Icons.Moon className="w-4 h-4" />}
                            <span className="text-xs font-bold">{isDarkMode ? 'Light Mode' : 'Dark Mode'}</span>
                        </button>
                        <div className="text-right">
                            <p className="text-xs text-slate-500 dark:text-slate-500 font-semibold">Version {APP_VERSION}</p>
                            <p className="text-[10px] text-slate-400 dark:text-slate-600">อัปเดตล่าสุด: {LAST_UPDATE}</p>
                        </div>
                    </div>
                </div>
            );
        };

        function MobileShopPOS() {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('pos');
            const [isDarkMode, setIsDarkMode] = useState(true);
            
            const [inventory, setInventory] = useState(INITIAL_STOCK);
            const [cart, setCart] = useState([]);
            const [partners, setPartners] = useState([]);
            const [salesLog, setSalesLog] = useState([]);
            const [categories, setCategories] = useState(INITIAL_CATEGORIES);
            const [users, setUsers] = useState(INITIAL_USERS);
            const [auditLogs, setAuditLogs] = useState([]);
            const [expenseList, setExpenseList] = useState([]); 
            const [repairQueue, setRepairQueue] = useState([]); 

            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            const [selectedDailyDetail, setSelectedDailyDetail] = useState(null);
            const [isCartExpanded, setIsCartExpanded] = useState(false);

            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportSettings, setExportSettings] = useState({ data: [], filename: '', columns: [], selected: [] });

            const [showCategoryModal, setShowCategoryModal] = useState(false);
            const [editCatIndex, setEditCatIndex] = useState(-1);
            const [editCatName, setEditCatName] = useState('');

            const [showDailySummaryModal, setShowDailySummaryModal] = useState(false);
            const [expenseForm, setExpenseForm] = useState({ name: '', amount: '' });
            const [expenseEditId, setExpenseEditId] = useState(null);

            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('ทั้งหมด');
            const [stockSearchQuery, setStockSearchQuery] = useState('');
            const [stockSelectedCategory, setStockSelectedCategory] = useState('ทั้งหมด');
            const [reportPeriod, setReportPeriod] = useState('daily');
            const [reportTab, setReportTab] = useState('transactions');

            const [showCheckoutModal, setShowCheckoutModal] = useState(false);
            const [discountModal, setDiscountModal] = useState({ show: false, index: null, amount: '', reason: '' });
            const [saleDetailModal, setSaleDetailModal] = useState({ show: false, sale: null });
            const [installmentPayModal, setInstallmentPayModal] = useState({ show: false, partner: null, amount: '' });
            const [importStockModal, setImportStockModal] = useState({ show: false, item: null, price: '', owner: '้านเรา', mode: 'full', commission: '' });
            const [stockEditId, setStockEditId] = useState(null);
            const [stockFormData, setStockFormData] = useState({});
            const [userModal, setUserModal] = useState(false);
            const [userForm, setUserForm] = useState({});

            const [checkoutStep, setCheckoutStep] = useState('select'); 
            const [checkoutForm, setCheckoutForm] = useState({ discount: '', reason: '' });

            const [repairData, setRepairData] = useState({ name: '', cost: '', price: '' });
            const [topupData, setTopupData] = useState({ carrier: 'True', amount: '' });
            const [installmentViewMode, setInstallmentViewMode] = useState('list');
            const [extForm, setExtForm] = useState({ shop: '', model: '', price: '', cost: '', mode: 'commission', commission: '' });
            
            const fileInputRef = useRef(null);

            useEffect(() => {
                const savedTheme = localStorage.getItem('pos_theme');
                if (savedTheme === 'light') setIsDarkMode(false);
            }, []);

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('pos_theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('pos_theme', 'light');
                }
            }, [isDarkMode]);

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            useEffect(() => {
                try {
                    const savedInv = localStorage.getItem('pos_inventory');
                    const savedSales = localStorage.getItem('pos_sales');
                    const savedPartners = localStorage.getItem('pos_partners');
                    const savedCats = localStorage.getItem('pos_categories');
                    const savedUsers = localStorage.getItem('pos_users');
                    const savedAudit = localStorage.getItem('pos_audit_logs');
                    const savedExpenses = localStorage.getItem('pos_expense_list'); 
                    const savedRepairQueue = localStorage.getItem('pos_repair_queue'); 

                    if(savedInv) setInventory(JSON.parse(savedInv) || INITIAL_STOCK);
                    if(savedSales) setSalesLog(JSON.parse(savedSales) || []);
                    if(savedPartners) setPartners(JSON.parse(savedPartners) || []);
                    if(savedCats) setCategories(JSON.parse(savedCats) || INITIAL_CATEGORIES);
                    if(savedUsers) setUsers(JSON.parse(savedUsers) || INITIAL_USERS);
                    if(savedAudit) setAuditLogs(JSON.parse(savedAudit) || []);
                    if(savedExpenses) setExpenseList(JSON.parse(savedExpenses) || []);
                    if(savedRepairQueue) setRepairQueue(JSON.parse(savedRepairQueue) || []);
                } catch (e) { console.error("Data load error", e); }
            }, []);

            useEffect(() => {
                localStorage.setItem('pos_inventory', JSON.stringify(inventory));
                localStorage.setItem('pos_sales', JSON.stringify(salesLog));
                localStorage.setItem('pos_partners', JSON.stringify(partners));
                localStorage.setItem('pos_categories', JSON.stringify(categories));
                localStorage.setItem('pos_users', JSON.stringify(users));
                localStorage.setItem('pos_audit_logs', JSON.stringify(auditLogs));
                localStorage.setItem('pos_expense_list', JSON.stringify(expenseList)); 
                localStorage.setItem('pos_repair_queue', JSON.stringify(repairQueue));
            }, [inventory, salesLog, partners, categories, users, auditLogs, expenseList, repairQueue]);

            const logAction = (action, details, userOverride = null) => {
                const newLog = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details,
                    user: userOverride ? userOverride : (currentUser ? currentUser.username : 'Unknown')
                };
                setAuditLogs(prev => [newLog, ...prev]);
            };

            const stockFiltered = useMemo(() => {
                const term = stockSearchQuery.toLowerCase();
                const catTerm = stockSelectedCategory === 'ทั้งหมด' ? '' : stockSelectedCategory.toLowerCase();
                return inventory.filter(i => {
                    const matchesSearch = i.name.toLowerCase().includes(term) || (i.productId && i.productId.toLowerCase().includes(term));
                    const matchesCategory = stockSelectedCategory === 'ทั้งหมด' || i.group.toLowerCase().includes(catTerm);
                    return matchesSearch && matchesCategory;
                });
            }, [inventory, stockSearchQuery, stockSelectedCategory]);

            const reportSummary = useMemo(() => {
                const filteredSales = salesLog.filter(sale => {
                    const d = getSafeDate(sale.date); const now = new Date();
                    if (reportPeriod === 'daily') return d.toDateString() === now.toDateString();
                    if (reportPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (reportPeriod === 'yearly') return d.getFullYear() === now.getFullYear();
                    return true;
                });
                
                return filteredSales.reduce((acc, curr) => {
                    const currentBillCost = curr.items.reduce((c, i) => c + ((i.cost || 0) * i.qty), 0);
                    const currentBillTopupProfit = curr.items.reduce((p, i) => i.name.startsWith('[เติมเงิน]') ? p + (((i.price - (i.cost || 0)) * i.qty) - (i.itemDiscount || 0)) : p, 0);
                    const currentBillTopupSales = curr.items.reduce((s, i) => i.name.startsWith('[เติมเงิน]') ? s + ((i.price * i.qty) - (i.itemDiscount || 0)) : s, 0);
                    
                    const isTransfer = curr.paymentMethod === 'transfer';
                    const saleTotal = curr.total;

                    return {
                        sales: acc.sales + saleTotal,
                        profit: acc.profit + curr.profit,
                        cost: acc.cost + currentBillCost,
                        topupSales: acc.topupSales + currentBillTopupSales,
                        topupProfit: acc.topupProfit + currentBillTopupProfit,
                        count: acc.count + 1,
                        cashSales: acc.cashSales + (isTransfer ? 0 : saleTotal),
                        transferSales: acc.transferSales + (isTransfer ? saleTotal : 0),
                        filteredSales: filteredSales
                    };
                }, { sales: 0, profit: 0, cost: 0, topupSales: 0, topupProfit: 0, count: 0, cashSales: 0, transferSales: 0, filteredSales: [] });
            }, [salesLog, reportPeriod]);

            const todayStats = useMemo(() => {
                const now = new Date();
                const todaySales = salesLog.filter(sale => {
                    const d = getSafeDate(sale.date);
                    return d.toDateString() === now.toDateString();
                });

                const itemBreakdown = {};
                todaySales.forEach(sale => {
                    sale.items.forEach(item => {
                        const cat = item.group || 'อื่นๆ';
                        if (!itemBreakdown[cat]) {
                            itemBreakdown[cat] = {
                                items: {},
                                maxItemPrice: 0 // To keep track of the most expensive individual item in this category
                            };
                        }
                        
                        // Track max price for category sorting
                        if (item.price > itemBreakdown[cat].maxItemPrice) {
                            itemBreakdown[cat].maxItemPrice = item.price;
                        }

                        if (!itemBreakdown[cat].items[item.name]) {
                            itemBreakdown[cat].items[item.name] = { 
                                name: item.name, 
                                qty: 0, 
                                total: 0,
                                productId: item.productId 
                            };
                        }
                        itemBreakdown[cat].items[item.name].qty += item.qty;
                        itemBreakdown[cat].items[item.name].total += ((item.price * item.qty) - (item.itemDiscount || 0));
                    });
                });

                const stats = todaySales.reduce((acc, curr) => {
                    const isTransfer = curr.paymentMethod === 'transfer';
                    const total = curr.total;
                    return {
                        sales: acc.sales + total,
                        cash: acc.cash + (isTransfer ? 0 : total),
                        transfer: acc.transfer + (isTransfer ? total : 0),
                        count: acc.count + 1
                    };
                }, { sales: 0, cash: 0, transfer: 0, count: 0 });

                return { ...stats, itemBreakdown };
            }, [salesLog]);

            const dailyList = useMemo(() => {
                const now = new Date();
                const currentMonthSales = salesLog.filter(sale => {
                     const d = getSafeDate(sale.date);
                     return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const dailyAggregates = currentMonthSales.reduce((acc, sale) => {
                    const dateKey = getSafeDate(sale.date).toISOString().split('T')[0];
                    const displayDate = getSafeDate(sale.date).toLocaleDateString('th-TH');
                    if (!acc[dateKey]) acc[dateKey] = { date: displayDate, sortKey: dateKey, sales: 0, cost: 0, profit: 0, count: 0, transactions: [], categorySummary: {} };
                    const saleCost = sale.items.reduce((c, i) => c + ((i.cost || 0) * i.qty), 0);
                    acc[dateKey].sales += sale.total;
                    acc[dateKey].profit += sale.profit;
                    acc[dateKey].cost += saleCost;
                    acc[dateKey].count += 1;
                    acc[dateKey].transactions.push(sale);
                    sale.items.forEach(item => {
                        const cat = item.group || (item.name.startsWith('[เติมเงิน]') ? 'เติมเงิน' : (item.name.startsWith('[ซ่อม]') ? 'ซ่อม' : 'อื่นๆ'));
                        if (!acc[dateKey].categorySummary[cat]) acc[dateKey].categorySummary[cat] = 0;
                        acc[dateKey].categorySummary[cat] += ((item.price * item.qty) - (item.itemDiscount || 0));
                    });
                    return acc;
                }, {});
                return Object.values(dailyAggregates).sort((a,b) => a.sortKey.localeCompare(b.sortKey));
            }, [salesLog]);

            const monthlyList = useMemo(() => {
                const now = new Date();
                const currentYearSales = salesLog.filter(sale => {
                    const d = getSafeDate(sale.date);
                    return d.getFullYear() === now.getFullYear();
                });
                const monthlyAggregates = currentYearSales.reduce((acc, sale) => {
                    const d = getSafeDate(sale.date);
                    const monthKey = d.toLocaleDateString('th-TH', { month: 'long' });
                    const monthIndex = d.getMonth();
                    if (!acc[monthIndex]) acc[monthIndex] = { month: monthKey, index: monthIndex, sales: 0, cost: 0, profit: 0, count: 0 };
                    const saleCost = sale.items.reduce((c, i) => c + ((i.cost || 0) * i.qty), 0);
                    acc[monthIndex].sales += sale.total;
                    acc[monthIndex].profit += sale.profit;
                    acc[monthIndex].cost += saleCost;
                    acc[monthIndex].count += 1;
                    return acc;
                }, {});
                return Object.values(monthlyAggregates).sort((a,b) => a.index - b.index);
            }, [salesLog]);
            
            const itemSummaryList = useMemo(() => {
                const filteredSales = salesLog.filter(sale => {
                    const d = getSafeDate(sale.date); const now = new Date();
                    if (reportPeriod === 'daily') return d.toDateString() === now.toDateString();
                    if (reportPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (reportPeriod === 'yearly') return d.getFullYear() === now.getFullYear();
                    return true;
                });
                const itemAgg = filteredSales.reduce((acc, sale) => {
                   sale.items.forEach(item => {
                       const key = item.name;
                       if(!acc[key]) acc[key] = { name: item.name, qty: 0, cost: 0, sales: 0, profit: 0 };
                       const totalItemPrice = (item.price * item.qty) - (item.itemDiscount || 0);
                       const totalItemCost = (item.cost || 0) * item.qty;
                       acc[key].qty += item.qty;
                       acc[key].sales += totalItemPrice;
                       acc[key].cost += totalItemCost;
                       acc[key].profit += (totalItemPrice - totalItemCost);
                   });
                   return acc;
                }, {});
                return Object.values(itemAgg).sort((a,b) => b.sales - a.sales);
            }, [salesLog, reportPeriod]);

            const todayExpenses = useMemo(() => {
                const now = new Date();
                return expenseList.filter(ex => {
                    const d = getSafeDate(ex.date);
                    return d.toDateString() === now.toDateString();
                });
            }, [expenseList]);

            const totalTodayExpenses = useMemo(() => todayExpenses.reduce((sum, ex) => sum + ex.amount, 0), [todayExpenses]);

            const showNotif = (msg, type = 'success') => { setNotification({ message: msg, type }); setTimeout(() => setNotification(null), 3000); };
            const confirmAction = (title, message, onConfirm) => { setConfirmData({ title, message, onConfirm: () => { onConfirm(); setConfirmData(null); } }); };
            
            const handleAddExpense = () => {
                if(!expenseForm.name || !expenseForm.amount) return showNotif('กรุณากรอกข้อมูลให้ครบ', 'error');
                const amt = parseNum(expenseForm.amount);
                
                if (expenseEditId !== null) {
                    setExpenseList(prev => prev.map(ex => ex.id === expenseEditId ? { ...ex, name: expenseForm.name, amount: amt } : ex));
                    logAction('แก้ไขรายจ่าย', `แก้ไขรายการ: ${expenseForm.name} เป็น ${amt.toLocaleString()} บาท`);
                    setExpenseEditId(null); 
                    showNotif('แก้ไขข้อมูลสำเร็จ');
                } else {
                    const newExpense = { 
                        id: Date.now(), 
                        name: expenseForm.name, 
                        amount: amt, 
                        date: new Date().toISOString() 
                    };
                    setExpenseList(prev => [...prev, newExpense]); 
                    logAction('เพิ่มรายจ่าย', `เพิ่มรายการ: ${expenseForm.name} ยอด ${amt.toLocaleString()} บาท`);
                    showNotif('เพิ่มรายจ่ายสำเร็จ');
                }
                setExpenseForm({ name: '', amount: '' });
            };

            const handleEditExpense = (expense) => { 
                setExpenseForm({ name: expense.name, amount: expense.amount }); 
                setExpenseEditId(expense.id); 
            };

            const handleDeleteExpense = (id) => {
                const item = expenseList.find(e => e.id === id);
                confirmAction('ลบรายจ่าย', `ต้องการลบรายการ "${item?.name}" ใช่หรือไม่?`, () => {
                    setExpenseList(prev => prev.filter(ex => ex.id !== id));
                    logAction('ลบรายจ่าย', `ลบรายการรายจ่าย: ${item?.name}`);
                    if(expenseEditId === id) { setExpenseEditId(null); setExpenseForm({ name: '', amount: '' }); }
                    showNotif('ลบรายการแล้ว');
                });
            };

            const handleLogin = (u, p) => {
                const user = users.find(user => user.username === u && user.password === p);
                if(user) { 
                    setCurrentUser(user);
                    logAction('เข้าสู่ระบบ', `ผู้ใช้ ${user.username} เข้าสู่ระบบ`, user.username);
                    if(user.role==='admin'||user.permissions.includes('pos')) setActiveTab('pos'); 
                    else if(user.permissions.length>0) setActiveTab(user.permissions[0]); 
                } else {
                    showNotif('รหัสผิด', 'error');
                }
            };
            const handleLogout = () => { logAction('ออกจากระบบ', `ผู้ใช้ ${currentUser.username} ออกจากระบบ`); setCurrentUser(null); setCart([]); };
            const hasPermission = (perm) => {
                if (!currentUser) return false;
                if (currentUser.role === 'admin' || currentUser.permissions.includes('all')) return true;
                return currentUser.permissions.includes(perm);
            };

            const handleAddRepair = () => {
                const name = repairData.name.trim(); 
                const price = parseNum(repairData.price); 
                const cost = parseNum(repairData.cost);
                
                if (!name || price <= 0) return showNotif('กรุณากรอกข้อมูล', 'error');

                const newRepairItem = { 
                    id: Date.now(), 
                    name: `[ซ่อม] ${name}`, 
                    price, 
                    cost, 
                    qty: 1,
                    addedDate: new Date().toISOString()
                };

                setRepairQueue(prev => [...prev, newRepairItem]);

                if (cost > 0) {
                    setExpenseList(prev => [...prev, {
                        id: Date.now() + 1,
                        name: `ต้นทุนงานซ่อม: ${name}`,
                        amount: cost,
                        date: new Date().toISOString()
                    }]);
                }

                setRepairData({name:'', cost:'', price:''}); 
                showNotif('บันทึกงานซ่อมแล้ว (รอรับเครื่อง)');
                logAction('รับงานซ่อม', `รับงานซ่อม: ${name} (รอรับเครื่อง)`);
            };

            const handleFinishRepairJob = (item) => {
                setRepairQueue(prev => prev.filter(i => i.id !== item.id));
                addToCart(item, 'service', { costAlreadyRecorded: true });
                showNotif('ย้ายไปตะกร้าเพื่อชำระเงินแล้ว');
            };

            const handleAddTopup = () => {
                const carrier = topupData.carrier; const amt = parseNum(topupData.amount);
                if (!amt || amt <= 0) return showNotif('กรุณาระบุยอดเงิน', 'error');
                const cost = amt - (amt * 0.03);
                addToCart({ id: Date.now(), name: `[เติมเงิน] ${carrier}`, price: amt, cost, qty: 1, group: 'เติมเงิน' }, 'service');
                setTopupData({carrier: 'True', amount:''}); showNotif('เพิ่มรายการเติมเงินแล้ว');
            };
            
            const generateID = () => {
                const pIds = inventory.map(i => i.productId).filter(pid => pid && pid.startsWith('P-')).map(pid => parseInt(pid.replace('P-', ''), 10)).filter(num => !isNaN(num));
                const maxId = pIds.length > 0 ? Math.max(...pIds) : 0;
                setStockFormData(prev => ({ ...prev, productId: 'P-' + (maxId + 1).toString().padStart(5, '0') }));
            };

            const handleStockSave = () => {
                const categoryName = stockFormData.group ? stockFormData.group.trim() : 'ทั่วไป';
                const newItem = { ...stockFormData, group: categoryName, qty: parseNum(stockFormData.qty), cost: parseNum(stockFormData.cost), price: parseNum(stockFormData.price) };
                
                if (newItem.productId && inventory.some(i => i.productId === newItem.productId && i.id !== stockEditId)) {
                    return showNotif('รหัสสินค้านี้มีอยู่แล้วในระบบ', 'error');
                }

                if (!categories.includes(categoryName) && categoryName !== '') setCategories(prev => [...prev, categoryName]);
                
                if (stockEditId === 'new') {
                    setInventory([...inventory, { ...newItem, id: Date.now() }]);
                    logAction('เพิ่มสินค้า', `เพิ่มสินค้าใหม่: ${newItem.name}`);
                } else {
                    setInventory(inventory.map(i => i.id === stockEditId ? newItem : i));
                    logAction('แก้ไขสินค้า', `แก้ไขสินค้า: ${newItem.name}`);
                }
                setStockEditId(null); showNotif('บันทึกสำเร็จ');
            };

            const handleRenameCategory = (index) => {
                const oldName = categories[index]; const newName = editCatName.trim();
                if(!newName || newName === oldName) { setEditCatIndex(-1); return; }
                if(categories.includes(newName)) return showNotif('ชื่อหมวดหมู่ซ้ำ', 'error');
                const newCats = [...categories]; newCats[index] = newName; setCategories(newCats);
                const newInv = inventory.map(item => item.group === oldName ? { ...item, group: newName } : item); setInventory(newInv);
                logAction('แก้ไขหมวดหมู่', `เปลี่ยนชื่อหมวดหมู่จาก "${oldName}" -> "${newName}"`);
                setEditCatIndex(-1); showNotif('แก้ไขชื่อหมวดหมู่สำเร็จ');
            };

            const handleDeleteCategory = (index) => {
                const catName = categories[index];
                if (catName === 'ทั่วไป') return showNotif('ไม่สามารถลบหมวดหมู่หลักได้', 'error');
                confirmAction('ลบหมวดหมู่', `สินค้าในหมวด "${catName}" จะถูกย้ายไป "ทั่วไป" ยืนยัน?`, () => {
                    const newInv = inventory.map(item => item.group === catName ? { ...item, group: 'ทั่วไป' } : item); setInventory(newInv);
                    const newCats = categories.filter((_, i) => i !== index); setCategories(newCats);
                    logAction('ลบหมวดหมู่', `ลบหมวดหมู่ "${catName}"`); showNotif('ลบหมวดหมู่แล้ว');
                });
            };

            const addToCart = (item, type='product', custom={}) => {
                if (type === 'service') { setCart([...cart, { ...item, type, qty: 1, itemDiscount: 0, itemDiscountReason: '', ...custom }]); showNotif('เพิ่มลงตะกร้า'); return; }
                const existingIndex = cart.findIndex(c => c.id === item.id && c.type === type);
                if (type==='product') {
                    if (item.qty <= 0) return showNotif('สินค้าหมด!', 'error');
                    if (existingIndex !== -1 && cart[existingIndex].qty + 1 > item.qty) return showNotif('สต็อกไม่พอ', 'error');
                }
                if (existingIndex !== -1) { const newCart = [...cart]; newCart[existingIndex] = { ...newCart[existingIndex], qty: newCart[existingIndex].qty + 1 }; setCart(newCart); }
                else { setCart([...cart, { ...item, type, qty: 1, itemDiscount: 0, itemDiscountReason: '', ...custom }]); }
                showNotif('เพิ่มลงตะกร้า');
            };

            const updateCartQty = (idx, delta) => {
                const newCart = [...cart]; if (!newCart[idx]) return;
                const newQty = newCart[idx].qty + delta;
                if (newQty <= 0) newCart.splice(idx, 1); else newCart[idx] = { ...newCart[idx], qty: newQty };
                setCart(newCart);
                if (newCart.length === 0) setIsCartExpanded(false);
            };

            const removeFromCart = (idx) => {
                const newCart = cart.filter((_, i) => i !== idx);
                setCart(newCart);
                if (newCart.length === 0) setIsCartExpanded(false);
                showNotif('ลบรายการแล้ว');
            };

            const openDiscountModal = (index) => {
                const item = cart[index]; if (!item) return;
                setDiscountModal({ show: true, index: index, amount: item.itemDiscount ? String(item.itemDiscount) : '', reason: item.itemDiscountReason || '' });
            };

            const saveDiscount = () => {
                if (discountModal.index !== null && cart[discountModal.index]) {
                    const newCart = [...cart]; const updatedItem = { ...newCart[discountModal.index] };
                    updatedItem.itemDiscount = parseNum(discountModal.amount); updatedItem.itemDiscountReason = discountModal.reason;
                    newCart[discountModal.index] = updatedItem; setCart(newCart); showNotif('บันทึกส่วนลดแล้ว');
                }
                setDiscountModal({ show: false, index: null, amount: '', reason: '' });
            };

            const calculateCartTotal = () => cart.reduce((sum, item) => sum + ((item.price * item.qty) - (item.itemDiscount || 0)), 0);
            
            const openCheckout = () => {
                setCheckoutForm({ discount: '', reason: '' });
                setCheckoutStep('select');
                setShowCheckoutModal(true);
            };

            const handleCheckout = (method, data) => {
                const { discount, reason } = data;
                const billDiscount = parseNum(discount);
                const billReason = reason || '';
                const total = calculateCartTotal();
                const netTotal = Math.max(0, total - billDiscount); 
                
                const saleRecord = { 
                    id: Date.now(), 
                    date: new Date().toISOString(), 
                    items: cart, 
                    subtotal: total, 
                    billDiscount, 
                    billDiscountReason: billReason, 
                    total: netTotal, 
                    profit: cart.reduce((sum, i) => sum + ((i.price - (i.cost||0))*i.qty) - (i.itemDiscount||0), 0) - billDiscount,
                    paymentMethod: method
                };

                const newInv = [...inventory];
                let newPartners = partners.map(p => ({...p}));
                const autoExpenses = [];

                cart.forEach(c => {
                    if(c.type === 'product') { 
                        const idx = newInv.findIndex(i => i.id === c.id); 
                        if(idx !== -1) newInv[idx] = { ...newInv[idx], qty: newInv[idx].qty - c.qty }; 
                    }
                    if(c.partnerId) { 
                        const idx = newPartners.findIndex(p => p.id === c.partnerId); 
                        if(idx !== -1) { 
                            if(c.installmentType === 'full') newPartners[idx].paidAmount = (newPartners[idx].paidAmount||0) + c.price; 
                            if(c.installmentType === 'commission') newPartners[idx].isFinished = true; 
                        } 
                    }
                    if(c.type === 'service' && c.name.startsWith('[ซ่อม]') && c.cost > 0 && !c.costAlreadyRecorded) {
                         autoExpenses.push({
                            id: Date.now() + Math.random(),
                            name: `ต้นทุน ${c.name} (บิล #${saleRecord.id})`,
                            amount: c.cost * c.qty,
                            date: new Date().toISOString()
                         });
                    }
                });

                newPartners = newPartners.filter(p => !(p.isFinished || (p.revenueMode==='full' && (p.price - (p.paidAmount||0)) <= 0)));
                
                setInventory(newInv); 
                setPartners(newPartners); 
                setSalesLog([...salesLog, saleRecord]); 

                if (autoExpenses.length > 0) {
                    setExpenseList(prev => [...prev, ...autoExpenses]);
                }

                setCart([]); 
                setShowCheckoutModal(false); 
                setIsCartExpanded(false);
                logAction('ขายสินค้า', `บิล #${saleRecord.id} ยอดรวม: ${netTotal.toLocaleString()} (${method})`);
                showNotif('บันทึกการขายสำเร็จ');
            };

            const confirmImportStock = () => {
                const { item, price, owner, mode, commission } = importStockModal; if(!item || !price) return;
                const newInv = inventory.map(i => i.id === item.id ? { ...i, qty: i.qty - 1 } : i); setInventory(newInv);
                setPartners([...partners, { id: Date.now(), type: 'internal', shop: owner, model: item.name, price: parseNum(price), cost: item.cost, revenueMode: mode, commission: parseNum(commission), paidAmount: 0, status: 'normal' }]);
                setImportStockModal({ show: false, item: null, price: '', owner: 'ร้านเรา', mode: 'full', commission: '' }); logAction('ดึงสินค้าฝาก', `ดึง ${item.name} ไปฝากขาย`); showNotif('ดึงสินค้าสำเร็จ');
            };

            const handleAddExternal = () => {
                if(!extForm.shop || !extForm.model) return showNotif('กรุณากรอกข้อมูลให้ครบ', 'error');
                setPartners([...partners, { ...extForm, id: Date.now(), type: 'external', price: parseNum(extForm.price), cost: parseNum(extForm.cost), commission: parseNum(extForm.commission), revenueMode: extForm.mode, paidAmount: 0, status: 'normal' }]);
                logAction('เพิ่มเครื่องฝาก', `เพิ่มเครื่องนอก: ${extForm.model}`); setExtForm({ shop: '', model: '', price: '', cost: '', mode: 'commission', commission: '' }); showNotif('เพิ่มเครื่องนอกสำเร็จ');
            };

            const confirmInstallmentPay = () => {
                const { partner, amount } = installmentPayModal; const amt = parseNum(amount); if(!amt) return;
                if(partner.revenueMode === 'full') {
                   const cost = (amt / partner.price) * partner.cost;
                   addToCart({ id: Date.now(), name: `[ค่างวด] ${partner.model}`, price: amt, cost, qty: 1 }, 'service', { partnerId: partner.id, installmentType: 'full' });
                } else {
                    if(partner.status === 'waiting_owner') { addToCart({ id: Date.now(), name: `[ค่าคอม] ${partner.model}`, price: amt, cost: 0, qty: 1 }, 'service', { partnerId: partner.id, installmentType: 'commission' }); } 
                    else { setPartners(partners.map(p => p.id === partner.id ? {...p, status: 'waiting_owner', pendingAmount: amt} : p)); showNotif('รับเงินลูกค้าแล้ว รอเคลียร์ยอดกับผู้ฝาก'); }
                }
                setInstallmentPayModal({ show: false, partner: null, amount: '' });
            };

            const handleUserSave = () => {
                if(!userForm.username || !userForm.password) return showNotif('กรอกข้อมูลไม่ครบ', 'error');
                if(userForm.id) { setUsers(users.map(u => u.id === userForm.id ? userForm : u)); logAction('แก้ไขผู้ใช้', `แก้ไขข้อมูลผู้ใช้ ${userForm.username}`); } 
                else { setUsers([...users, { ...userForm, id: Date.now() }]); logAction('เพิ่มผู้ใช้', `เพิ่มผู้ใช้ใหม่: ${userForm.username}`); }
                setUserModal(false);
            };

            const togglePermission = (perm) => {
                let newPerms = userForm.permissions || [];
                if (newPerms.includes('all')) newPerms = [];
                if (newPerms.includes(perm)) newPerms = newPerms.filter(p => p !== perm); else newPerms = [...newPerms, perm];
                setUserForm({ ...userForm, permissions: newPerms });
            };

            const handleExportData = () => {
                const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ inventory, salesLog, partners, categories, users, auditLogs, expenseList }));
                const a = document.createElement('a'); a.href = data; a.download = "backup.json"; a.click();
            };

            const handleImportData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try { const d = JSON.parse(ev.target.result); if(d.inventory) { confirmAction('กู้คืนข้อมูล', 'ยืนยัน?', () => { setInventory(d.inventory); setSalesLog(d.salesLog); setPartners(d.partners); setCategories(d.categories); if(d.users) setUsers(d.users); if(d.auditLogs) setAuditLogs(d.auditLogs); if(d.expenseList) setExpenseList(d.expenseList); showNotif('กู้คืนสำเร็จ'); }); } } catch(err) { showNotif('ไฟล์เสียหาย', 'error'); }
                };
                r.readAsText(file); e.target.value = null;
            };

            const exportToCSV = (data, filename, customColumns = null) => {
                if (!data || !data.length) return showNotif('ไม่มีข้อมูล', 'error');
                const BOM = "\uFEFF";
                let headers = "", rows = "";
                if (customColumns) {
                    headers = customColumns.map(c => c.header).join(",");
                    rows = data.map(item => customColumns.map(c => { let val = c.accessor(item); if (val === null || val === undefined) val = ""; return `"${String(val).replace(/"/g, '""')}"`; }).join(",")).join("\n");
                }
                const blob = new Blob([BOM + headers + "\n" + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); const url = URL.createObjectURL(blob);
                link.setAttribute("href", url); link.setAttribute("download", filename);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleOpenExport = (type, data) => {
                const showCostProfit = currentUser?.role === 'admin';
                let cols = []; let filename = '';
                if (type === 'daily') { filename = 'daily.csv'; cols = [{ id: 'date', header: 'วันที่', accessor: d => d.date }, { id: 'sales', header: 'ยอดขาย', accessor: d => d.sales }]; if(showCostProfit) cols.push({ id: 'profit', header: 'กำไร', accessor: d => d.profit }); }
                else if (type === 'monthly') { filename = 'monthly.csv'; cols = [{ id: 'month', header: 'เดือน', accessor: d => d.month }, { id: 'sales', header: 'ยอดขาย', accessor: d => d.sales }]; }
                else if (type === 'item') { filename = 'item.csv'; cols = [{ id: 'name', header: 'สินค้า', accessor: d => d.name }, { id: 'qty', header: 'จำนวน', accessor: d => d.qty }, { id: 'sales', header: 'ยอดขาย', accessor: d => d.sales }]; }
                setExportSettings({ data, filename, columns: cols, selected: cols.map(c => c.id) }); setExportModalOpen(true);
            };

            const toggleExportColumn = (colId) => {
                setExportSettings(prev => { const newSelected = prev.selected.includes(colId) ? prev.selected.filter(id => id !== colId) : [...prev.selected, colId]; return { ...prev, selected: newSelected }; });
            };

            const confirmExport = () => {
                const finalColumns = exportSettings.columns.filter(c => exportSettings.selected.includes(c.id));
                if (finalColumns.length === 0) return showNotif('เลือกอย่างน้อย 1 คอลัมน์', 'error');
                exportToCSV(exportSettings.data, exportSettings.filename, finalColumns); setExportModalOpen(false);
            };

            const handleExportDailyPDF = () => {
                const element = document.getElementById('daily-summary-content');
                const dateStr = new Date().toISOString().split('T')[0];
                const opt = {
                    margin:       10,
                    filename:     `Daily_Summary_${dateStr}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, logging: false },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // temporary style adjustment for PDF
                const originalStyle = element.style.cssText;
                element.style.color = '#000'; // Ensure text is black for PDF
                
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.cssText = originalStyle;
                });
            };

            if (!currentUser) return <LoginScreen onLogin={handleLogin} isDarkMode={isDarkMode} toggleTheme={toggleTheme} />;

            // --- VIEW RENDER FUNCTIONS ---
            const renderUsersView = () => (
                <div className="max-w-4xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold dark:text-white">จัดการผู้ใช้</h2><Button onClick={() => { setUserForm({ permissions: [] }); setUserModal(true); }}><Icons.Plus className="w-4 h-4 mr-1"/> เพิ่มผู้ใช้</Button></div><div className="bg-white dark:bg-slate-800 rounded-xl shadow overflow-hidden"><table className="w-full text-left"><thead className="bg-slate-50 dark:bg-slate-700 border-b dark:border-slate-700"><tr><th className="p-4 dark:text-slate-300">ชื่อ</th><th className="p-4 dark:text-slate-300">Username</th><th className="p-4 dark:text-slate-300">Role</th><th className="p-4 dark:text-slate-300">จัดการ</th></tr></thead><tbody className="divide-y dark:divide-slate-700">{users.map(u => (<tr key={u.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-4 dark:text-slate-300">{u.name}</td><td className="p-4 font-mono text-slate-500 dark:text-slate-400">{u.username}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs ${u.role==='admin'?'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300':'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300'}`}>{u.role}</span></td><td className="p-4 flex gap-2"><button onClick={() => { setUserForm(u); setUserModal(true); }} className="text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900/50 p-2 rounded"><Icons.Edit className="w-4 h-4"/></button>{u.username !== 'admin' && <button onClick={() => confirmAction('ลบผู้ใช้', `ยืนยันลบ ${u.name}?`, () => { setUsers(users.filter(user => user.id !== u.id)); logAction('ลบผู้ใช้', `ลบผู้ใช้: ${u.username}`); })} className="text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50 p-2 rounded"><Icons.Trash2 className="w-4 h-4"/></button>}</td></tr>))}</tbody></table></div>
                    {userModal && (<Modal title={userForm.id ? "แก้ไขผู้ใช้" : "เพิ่มผู้ใช้"} onClose={() => setUserModal(false)}><div className="space-y-4"><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="ชื่อ-นามสกุล" value={userForm.name||''} onChange={e=>setUserForm({...userForm, name: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input className="p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Username" value={userForm.username||''} onChange={e=>setUserForm({...userForm, username: e.target.value})} disabled={userForm.id && userForm.username==='admin'} /><input className="p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Password" value={userForm.password||''} onChange={e=>setUserForm({...userForm, password: e.target.value})} /></div><div><label className="block mb-2 font-medium dark:text-slate-300">ระดับสิทธิ์ (Role)</label><div className="flex gap-4 dark:text-slate-300"><label className="flex items-center gap-2"><input type="radio" name="role" checked={userForm.role === 'admin'} onChange={() => setUserForm({ ...userForm, role: 'admin', permissions: ['all'] })} /> Admin (ทุกอย่าง)</label><label className="flex items-center gap-2"><input type="radio" name="role" checked={userForm.role === 'staff'} onChange={() => setUserForm({ ...userForm, role: 'staff', permissions: [] })} /> Staff (จำกัดสิทธิ์)</label></div></div>{userForm.role === 'staff' && (<div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded border dark:border-slate-600"><label className="block mb-2 text-sm font-medium text-slate-500 dark:text-slate-400">เลือกสิทธิ์การใช้งาน:</label><div className="grid grid-cols-2 gap-2 dark:text-slate-300">{Object.keys(PERMISSION_LABELS).map(key => (<label key={key} className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={userForm.permissions?.includes(key)} onChange={() => togglePermission(key)} /> {PERMISSION_LABELS[key]}</label>))}</div></div>)}<Button onClick={handleUserSave} className="w-full">บันทึก</Button></div></Modal>)}
                </div>
            );

            const renderAuditLogView = () => (
                <div className="max-w-6xl mx-auto p-4 md:p-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold flex items-center gap-2 dark:text-white"><Icons.History className="text-slate-600 dark:text-slate-400"/> ประวัติการใช้งาน</h2><div className="text-sm text-slate-500 dark:text-slate-400">ทั้งหมด: {auditLogs.length}</div></div>
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-slate-50 dark:bg-slate-700 border-b dark:border-slate-700"><tr><th className="p-4 w-40 dark:text-slate-300">เวลา</th><th className="p-4 w-32 dark:text-slate-300">ผู้ใช้</th><th className="p-4 w-40 dark:text-slate-300">กิจกรรม</th><th className="p-4 dark:text-slate-300">รายละเอียด</th></tr></thead><tbody className="divide-y dark:divide-slate-700">{auditLogs.slice(0, 100).map(log => (<tr key={log.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-4 text-sm text-slate-500 dark:text-slate-400 font-mono whitespace-nowrap">{new Date(log.timestamp).toLocaleString('th-TH')}</td><td className="p-4"><span className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-2 py-1 rounded text-xs font-bold">{log.user}</span></td><td className="p-4 font-medium text-blue-600 dark:text-blue-400">{log.action}</td><td className="p-4 text-slate-600 dark:text-slate-300 text-sm">{log.details}</td></tr>))}</tbody></table></div></div>
                </div>
            );

            const renderServicesView = () => (
                <div className="flex flex-col md:flex-row gap-6 max-w-6xl mx-auto p-6">
                    <div className="flex-1 space-y-6">
                        <Card className="p-6">
                            <div className="flex items-center gap-2 mb-6 text-orange-600 dark:text-orange-400 font-bold text-xl"><Icons.Wrench /> บริการรับซ่อม (รับงาน)</div>
                            <div className="space-y-4">
                                <input placeholder="รายการซ่อม (เช่น เปลี่ยนจอ)" className="w-full p-3 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" value={repairData.name} onChange={e => setRepairData({...repairData, name: e.target.value})} />
                                <div className="grid grid-cols-2 gap-4">
                                    <input type="number" className="w-full p-3 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" placeholder="ต้นทุน (หักรายจ่ายเลย)" value={repairData.cost} onChange={e => setRepairData({...repairData, cost: e.target.value})} />
                                    <input type="number" className="w-full p-3 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" placeholder="ราคา (เก็บลูกค้า)" value={repairData.price} onChange={e => setRepairData({...repairData, price: e.target.value})} />
                                </div>
                                <Button onClick={handleAddRepair} className="w-full bg-orange-600 hover:bg-orange-700">บันทึก (เข้าคิวซ่อม)</Button>
                            </div>
                        </Card>

                        <Card className="p-6">
                            <div className="flex items-center gap-2 mb-6 text-green-600 dark:text-green-400 font-bold text-xl"><Icons.Wifi /> บริการเติมเงิน</div>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-bold text-slate-500 mb-3 dark:text-slate-400">เลือกค่ายมือถือ:</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['True', 'Dtac', 'Ais'].map(c => (
                                            <button 
                                                key={c}
                                                onClick={() => setTopupData({...topupData, carrier: c})}
                                                className={`py-3 rounded-xl font-bold transition-all border-2 ${topupData.carrier === c 
                                                    ? (c === 'True' ? 'bg-red-600 text-white border-red-600' : c === 'Dtac' ? 'bg-blue-500 text-white border-blue-500' : 'bg-green-600 text-white border-green-600')
                                                    : 'bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-100'
                                                }`}
                                            >
                                                {c}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="relative">
                                    <span className="absolute left-3 top-3.5 text-slate-400 font-bold">฿</span>
                                    <input 
                                        type="number" 
                                        className="w-full pl-8 p-3 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white font-bold text-xl" 
                                        placeholder="ระบุยอดเงินเติม" 
                                        value={topupData.amount} 
                                        onChange={e => setTopupData({...topupData, amount: e.target.value})} 
                                    />
                                </div>
                                <Button onClick={handleAddTopup} className="w-full bg-green-600 hover:bg-green-700 text-lg py-3">เพิ่มลงรายการขาย</Button>
                            </div>
                        </Card>
                    </div>

                    <div className="flex-1">
                        <Card className="p-6 h-full">
                            <div className="flex items-center gap-2 mb-6 text-slate-700 dark:text-slate-200 font-bold text-xl"><Icons.Clock /> รายการที่กำลังซ่อม (รอรับ)</div>
                            <div className="space-y-3">
                                {repairQueue.length === 0 ? (
                                    <div className="text-center text-slate-400 py-10">ไม่มีงานซ่อมค้างอยู่</div>
                                ) : (
                                    repairQueue.map(item => (
                                        <div key={item.id} className="border dark:border-slate-700 p-4 rounded-lg bg-white dark:bg-slate-800 shadow-sm flex flex-col gap-3">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className="font-bold text-lg dark:text-white">{item.name.replace('[ซ่อม] ', '')}</div>
                                                    <div className="text-sm text-slate-500 dark:text-slate-400">รับเมื่อ: {new Date(item.addedDate).toLocaleString('th-TH')}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-bold text-xl text-blue-600 dark:text-blue-400">฿{item.price.toLocaleString()}</div>
                                                    <div className="text-xs text-slate-400">ต้นทุน: {item.cost.toLocaleString()} (หักแล้ว)</div>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <Button onClick={() => handleFinishRepairJob(item)} className="flex-1 bg-green-600 hover:bg-green-700 text-white">
                                                    <Icons.Check className="w-4 h-4 mr-2" /> แจ้งซ่อมเสร็จ / รับเครื่อง
                                                </Button>
                                                <Button variant="danger" onClick={() => confirmAction('ลบงานซ่อม', 'ต้องการลบรายการนี้ใช่หรือไม่?', () => setRepairQueue(prev => prev.filter(i => i.id !== item.id)))} className="px-3">
                                                    <Icons.Trash2 className="w-4 h-4" />
                                                </Button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </Card>
                    </div>
                </div>
            );

            const renderStockView = () => (
                <div className="max-w-6xl mx-auto p-4">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-slate-800 dark:text-white">จัดการสต็อก</h2><div className="flex items-center bg-blue-600 rounded-lg shadow-lg hover:shadow-blue-200 transition-all overflow-hidden group"><button onClick={() => { setStockEditId('new'); setStockFormData({group: categories[0] || 'ทั่วไป', name: '', qty: 1, cost: 0, price: 0, productId: ''}); }} className="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white font-bold hover:bg-blue-700 active:bg-blue-800 transition-colors"><div className="bg-white/20 p-1 rounded-full"><Icons.Plus className="w-4 h-4"/></div><span>เพิ่มสินค้า</span></button><div className="w-[1px] h-6 bg-blue-400/50"></div><button onClick={() => setShowCategoryModal(true)} className="px-3 py-2.5 bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 transition-colors"><Icons.Settings className="w-5 h-5"/></button></div></div>
                    <div className="mb-6 flex flex-col md:flex-row gap-2"><div className="relative flex-1"><span className="absolute left-3 top-2.5 text-slate-400"><Icons.Search className="w-4 h-4"/></span><input className="w-full pl-10 p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white" placeholder="ค้นหา (ชื่อ/รหัส)..." value={stockSearchQuery} onChange={e => setStockSearchQuery(e.target.value)} /></div><div className="relative w-full md:w-1/3 min-w-[200px]"><div className="absolute left-3 top-3 text-slate-500 pointer-events-none"><Icons.Filter size={18} /></div><input list="stock-category-list" type="text" className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800 text-slate-700 dark:text-white font-medium" placeholder="หมวดหมู่..." value={stockSelectedCategory === 'ทั้งหมด' ? '' : stockSelectedCategory} onChange={e => setStockSelectedCategory(e.target.value || 'ทั้งหมด')} onFocus={(e) => e.target.select()} /><datalist id="stock-category-list"><option value="ทั้งหมด">ทั้งหมด</option>{categories.map(c => <option key={c} value={c} />)}</datalist></div></div>
                    <div className="bg-white dark:bg-slate-800 rounded shadow overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 dark:bg-slate-700 border-b dark:border-slate-700"><tr><th className="p-3 dark:text-slate-300">ID</th><th className="p-3 dark:text-slate-300">หมวด</th><th className="p-3 dark:text-slate-300">ชื่อสินค้า</th><th className="p-3 text-center dark:text-slate-300">คงเหลือ</th><th className="p-3 text-right dark:text-slate-300">ทุน</th><th className="p-3 text-right dark:text-slate-300">ขาย</th><th className="p-3 text-center dark:text-slate-300">จัดการ</th></tr></thead><tbody className="divide-y dark:divide-slate-700">{stockFiltered.map(item => (<tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-3 text-xs text-slate-400 font-mono">{item.productId || '-'}</td><td className="p-3 text-sm text-slate-500 dark:text-slate-400">{item.group}</td><td className="p-3 font-medium dark:text-slate-200">{item.name}</td><td className="p-3 text-center"><span className={`px-2 py-1 rounded-full text-xs ${item.qty>0?'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300':'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'}`}>{item.qty}</span></td><td className="p-3 text-right dark:text-slate-300">{item.cost.toLocaleString()}</td><td className="p-3 text-right font-bold text-blue-600 dark:text-blue-400">{item.price.toLocaleString()}</td><td className="p-3 flex justify-center gap-2"><button onClick={() => { setStockEditId(item.id); setStockFormData(item); }} className="p-2 bg-blue-50 dark:bg-slate-700 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-slate-600"><Icons.Edit className="w-4 h-4"/></button><button onClick={() => confirmAction('ลบสินค้า', `ต้องการลบ ${item.name}?`, () => { setInventory(inventory.filter(x=>x.id!==item.id)); logAction('ลบสินค้า', `ลบสินค้า: ${item.name}`); })} className="p-2 bg-red-50 dark:bg-slate-700 text-red-600 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-slate-600"><Icons.Trash2 className="w-4 h-4"/></button></td></tr>))}</tbody></table></div>
                    {stockEditId && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><Card className="w-full max-w-md p-6"><h3 className="text-xl font-bold mb-4 dark:text-white">{stockEditId === 'new' ? 'เพิ่มสินค้าใหม่' : 'แก้ไขสินค้า'}</h3><div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">หมวดหมู่</label><input list="cat-options" className="w-full p-2 border dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" value={stockFormData.group} onChange={e=>setStockFormData({...stockFormData, group: e.target.value})} placeholder="ระบุหมวดหมู่..." /><datalist id="cat-options">{categories.map(c => <option key={c} value={c} />)}</datalist></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">รหัสสินค้า (ต้องไม่ซ้ำ)</label><div className="flex gap-2"><input className="flex-1 p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="ยิงบาร์โค้ด หรือ พิมพ์รหัส" value={stockFormData.productId||''} onChange={e=>setStockFormData({...stockFormData, productId: e.target.value})}/><Button variant="secondary" onClick={generateID} className="px-3 text-xs">Auto</Button></div></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">ชื่อสินค้า</label><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="ระบุชื่อสินค้า" value={stockFormData.name} onChange={e=>setStockFormData({...stockFormData, name: e.target.value})}/></div>
                        <div className="grid grid-cols-3 gap-3"><div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">จำนวน</label><input type="number" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="0" value={stockFormData.qty} onChange={e=>setStockFormData({...stockFormData, qty: e.target.value})}/></div><div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">ราคาทุน</label><input type="number" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="0.00" value={stockFormData.cost} onChange={e=>setStockFormData({...stockFormData, cost: e.target.value})}/></div><div><label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">ราคาขาย</label><input type="number" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="0.00" value={stockFormData.price} onChange={e=>setStockFormData({...stockFormData, price: e.target.value})}/></div></div>
                        <div className="flex gap-2 pt-4"><Button variant="secondary" className="flex-1" onClick={() => setStockEditId(null)}>ยกเลิก</Button><Button className="flex-1" onClick={handleStockSave}>บันทึก</Button></div>
                    </div></Card></div>)}
                    {showCategoryModal && (<Modal title="จัดการหมวดหมู่" onClose={() => setShowCategoryModal(false)}><div className="space-y-2">{categories.map((cat, idx) => (<div key={idx} className="flex gap-2 items-center p-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700/50">{editCatIndex === idx ? (<React.Fragment><input className="flex-1 p-1 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={editCatName} onChange={e => setEditCatName(e.target.value)} autoFocus /><button onClick={() => handleRenameCategory(idx)} className="text-green-600 p-1"><Icons.Check/></button><button onClick={() => setEditCatIndex(-1)} className="text-red-500 p-1"><Icons.X/></button></React.Fragment>) : (<React.Fragment><span className="flex-1 font-medium dark:text-slate-200">{cat}</span><button onClick={() => { setEditCatIndex(idx); setEditCatName(cat); }} className="text-blue-500 p-1 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded"><Icons.Edit className="w-4 h-4"/></button>{cat !== 'ทั่วไป' && (<button onClick={() => handleDeleteCategory(idx)} className="text-red-500 p-1 hover:bg-red-100 dark:hover:bg-blue-900/30 rounded"><Icons.Trash2 className="w-4 h-4"/></button>)}</React.Fragment>)}</div>))}<div className="mt-4 pt-4 border-t dark:border-slate-600"><form onSubmit={(e) => { e.preventDefault(); const val = e.target.newCat.value.trim(); if(val && !categories.includes(val)) { setCategories([...categories, val]); e.target.reset(); logAction('เพิ่มหมวดหมู่', `เพิ่มหมวดหมู่ใหม่: ${val}`); showNotif('เพิ่มหมวดหมู่แล้ว'); } }} className="flex gap-2"><input name="newCat" className="flex-1 p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="เพิ่มหมวดหมู่ใหม่..." /><Button type="submit" variant="primary"><Icons.Plus className="w-4 h-4"/></Button></form></div></div></Modal>)}
                </div>
            );

            const renderPOSView = () => {
                const filtered = inventory.filter(i => {
                    const q = searchQuery.toLowerCase(); const cat = selectedCategory === 'ทั้งหมด' || i.group.toLowerCase().includes(selectedCategory.toLowerCase());
                    return (i.name.toLowerCase().includes(q) || (i.productId||'').toLowerCase().includes(q)) && cat;
                });
                
                const cartCount = cart.length;
                const cartTotal = calculateCartTotal();

                return (
                    <div className="flex flex-col h-full lg:flex-row relative">
                        <div className="flex-1 p-4 overflow-y-auto pb-24 lg:pb-4">
                            <div className="flex gap-2 mb-4 sticky top-0 bg-slate-100 dark:bg-slate-900 pt-2 pb-2 z-10"><div className="relative flex-1"><span className="absolute left-3 top-2.5 text-gray-400"><Icons.Search className="w-4 h-4"/></span><input className="w-full pl-10 p-2 border dark:border-slate-600 rounded shadow-sm dark:bg-slate-800 dark:text-white" placeholder="ค้นหา..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} autoFocus /></div><div className="relative w-1/3 min-w-[120px]"><span className="absolute left-3 top-2.5 text-gray-500 pointer-events-none"><Icons.Filter className="w-4 h-4"/></span><input list="pos-cats" className="w-full pl-10 p-2 border dark:border-slate-600 rounded shadow-sm dark:bg-slate-800 dark:text-white" placeholder="หมวดหมู่" value={selectedCategory==='ทั้งหมด'?'':selectedCategory} onChange={e=>setSelectedCategory(e.target.value||'ทั้งหมด')} onFocus={e=>e.target.select()}/><datalist id="pos-cats"><option value="ทั้งหมด"/>{categories.map(c=><option key={c} value={c}/>)}</datalist></div></div>
                            <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3">{filtered.map(item => (<div key={item.id} onClick={()=>addToCart(item)} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm hover:shadow-md cursor-pointer border border-transparent dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500 transition-all"><div className="flex justify-between items-start mb-2"><span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-600 dark:text-slate-300">{item.group}</span><span className={`text-[10px] px-2 py-0.5 rounded ${item.qty>0?'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300':'bg-red-100 dark:bg-green-900/30 text-red-700 dark:text-red-300'}`}>{item.qty>0?`เหลือ ${item.qty}`:'หมด'}</span></div><div className="font-semibold text-gray-800 dark:text-white line-clamp-1">{item.name}</div><div className="text-xs text-gray-400 font-mono mb-1">{item.productId}</div><div className="text-lg font-bold text-blue-600 dark:text-blue-400">฿{item.price.toLocaleString()}</div></div>))}</div>
                        </div>

                        <div className={`
                            fixed z-[45] cart-transition
                            lg:static lg:w-96 lg:h-full lg:flex lg:flex-col lg:bg-white lg:dark:bg-slate-800 lg:border-l lg:dark:border-slate-700 lg:shadow-none lg:p-0 lg:rounded-none lg:visible lg:opacity-100
                            ${isCartExpanded ? 'bottom-0 left-0 w-full h-[85vh] rounded-t-3xl shadow-2xl overflow-hidden flex flex-col bg-white dark:bg-slate-800 border-t dark:border-slate-700' : 'bottom-6 right-6 w-auto h-auto lg:h-full lg:w-96'}
                        `}>
                            <div 
                                className={`
                                    cursor-pointer lg:cursor-default flex items-center p-3 select-none transition-all duration-300
                                    lg:bg-slate-50 lg:dark:bg-slate-750 lg:border-b lg:dark:border-slate-700 lg:w-full lg:rounded-none lg:shadow-none lg:justify-between lg:flex
                                    ${isCartExpanded ? 'bg-slate-50 dark:bg-slate-750 border-b dark:border-slate-700 font-bold justify-between' : 'bg-blue-600 text-white rounded-full shadow-2xl px-5 py-3 hover:bg-blue-700 active:scale-95 lg:hidden ring-4 ring-white dark:ring-slate-900 shadow-blue-500/30'}
                                `}
                                onClick={() => { if(window.innerWidth < 1024) setIsCartExpanded(!isCartExpanded); }}
                            >
                                <div className="flex items-center gap-3">
                                    <div className="relative">
                                        <Icons.ShoppingCart className={`w-5 h-5 ${ (isCartExpanded || window.innerWidth >= 1024) ? 'text-blue-600 dark:text-blue-400 lg:text-slate-600 lg:dark:text-slate-300' : 'text-white'}`} />
                                        {cartCount > 0 && <span className={`absolute -top-3 -right-2 text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold border-2 ${ (isCartExpanded || window.innerWidth >= 1024) ? 'bg-red-500 text-white border-white dark:border-slate-800' : 'bg-white text-blue-600 border-blue-600'}`}>{cartCount}</span>}
                                    </div>
                                    <div className="flex flex-col">
                                        <span className={`text-sm ${ (isCartExpanded || window.innerWidth >= 1024) ? 'text-slate-800 dark:text-white' : 'font-bold'}`}>
                                            {(isCartExpanded || window.innerWidth >= 1024) ? 'รายการในตะกร้า' : `฿${cartTotal.toLocaleString()}`}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    {(isCartExpanded || window.innerWidth >= 1024) && cartCount > 0 && (
                                        <button onClick={(e)=>{e.stopPropagation(); confirmAction('ล้างตะกร้า', 'ต้องการลบรายการทั้งหมด?', () => { setCart([]); setIsCartExpanded(false); })}} className="text-red-500 text-[10px] px-3 py-1.5 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 font-bold">ล้างทั้งหมด</button>
                                    )}
                                    <span className="lg:hidden text-slate-400">
                                        {isCartExpanded ? <Icons.ChevronDown className="w-6 h-6"/> : null}
                                    </span>
                                </div>
                            </div>

                            <div className={`flex-1 overflow-y-auto p-4 space-y-3 ${!isCartExpanded && window.innerWidth < 1024 ? 'hidden' : 'block'}`}>
                                {cart.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 py-12 opacity-60">
                                        <div className="bg-slate-100 dark:bg-slate-700/50 p-6 rounded-full mb-4"><Icons.Package className="w-16 h-16" /></div>
                                        <p className="text-base font-medium">ยังไม่มีสินค้าในตะกร้า</p>
                                    </div>
                                ) : (
                                    cart.map((item,idx) => (
                                        <div key={item.id || idx} className="bg-slate-50 dark:bg-slate-700/40 p-3 rounded-2xl border border-slate-200/50 dark:border-slate-600/50 fade-in shadow-sm relative group">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1 pr-2">
                                                    <span className="font-bold text-sm dark:text-white leading-tight block">{item.name}</span>
                                                    <span className="text-[10px] text-slate-400 font-mono">{item.productId || 'SERVICE'}</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="font-black dark:text-white text-base text-blue-600 dark:text-blue-400 whitespace-nowrap">฿{((item.price*item.qty)-(item.itemDiscount||0)).toLocaleString()}</span>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center mt-3">
                                                <div className="flex items-center bg-white dark:bg-slate-600 rounded-xl p-1 shadow-sm border dark:border-slate-500">
                                                    <button onClick={()=>updateCartQty(idx,-1)} className="w-8 h-8 flex items-center justify-center text-slate-400 dark:text-slate-200 hover:text-red-500 active:scale-75 transition-all text-xl">-</button>
                                                    <span className="w-8 text-center text-sm font-black dark:text-white">{item.qty}</span>
                                                    <button onClick={()=>updateCartQty(idx,1)} className="w-8 h-8 flex items-center justify-center text-blue-600 dark:text-blue-300 hover:text-blue-700 active:scale-75 transition-all text-xl">+</button>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={()=>{openDiscountModal(idx)}} className="text-[11px] bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-3 py-1.5 rounded-lg font-bold border border-blue-100 dark:border-blue-900/50">ลดราคา</button>
                                                    <button onClick={()=>removeFromCart(idx)} className="p-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-100" title="ลบรายการ">
                                                        <Icons.Trash2 className="w-4 h-4"/>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>

                            <div className={`p-5 border-t dark:border-slate-700 bg-white dark:bg-slate-800 rounded-b-3xl lg:rounded-none ${!isCartExpanded && window.innerWidth < 1024 ? 'hidden' : 'block'}`}>
                                <div className="flex justify-between mb-5 items-end">
                                    <div className="flex flex-col">
                                        <span className="text-xs text-slate-400 uppercase font-bold tracking-wider">ยอดรวมสุทธิ</span>
                                        <span className="text-xs text-slate-500">{cartCount} รายการ</span>
                                    </div>
                                    <span className="text-3xl font-black text-blue-600 dark:text-blue-400 tracking-tight">฿{cartTotal.toLocaleString()}</span>
                                </div>
                                <button 
                                    onClick={openCheckout} 
                                    disabled={cartCount === 0} 
                                    className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-300/40 dark:shadow-none disabled:opacity-50 hover:bg-blue-700 active:scale-[0.98] transition-all text-xl flex justify-center items-center gap-3"
                                >
                                    <Icons.Check size={24} /> ชำระเงินทันที
                                </button>
                            </div>
                        </div>
                        
                        {isCartExpanded && window.innerWidth < 1024 ? (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-[3px] z-40 lg:hidden" onClick={() => setIsCartExpanded(false)}></div>
                        ) : null}
                    </div>
                );
            };

            const renderInstallmentView = () => (
                <div className="max-w-5xl mx-auto p-6">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h2 className="text-2xl font-bold text-slate-800 dark:text-white">ระบบฝากผ่อน</h2><div className="flex gap-2 w-full md:w-auto"><Button variant="outline" onClick={() => setInstallmentViewMode('import_stock')}><Icons.ArrowRightLeft className="w-4 h-4"/> ดึงจากร้าน</Button><Button onClick={() => setInstallmentViewMode('add_ext')}><Icons.Plus className="w-4 h-4"/> เพิ่มเครื่องนอก</Button></div></div>
                    {installmentViewMode === 'list' && (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{partners.map(p => (<Card key={p.id} className="p-4 border-l-4" style={{ borderLeftColor: p.type === 'internal' ? '#ef4444' : '#a855f7' }}><div className="mb-4"><div className="flex justify-between mb-2"><span className={`px-2 py-1 rounded text-xs font-bold text-white ${p.type === 'internal' ? 'bg-red-500' : 'bg-purple-500'}`}>{p.type === 'internal' ? 'เครื่องร้าน' : 'เครื่องฝาก'}</span><span className="text-slate-400 text-xs">ID: {p.id}</span></div><h3 className="font-bold text-lg dark:text-white">{p.model}</h3><div className="text-sm text-slate-500 dark:text-slate-400 mb-2">เจ้าของ: {p.shop}</div>{p.revenueMode === 'commission' ? (<div className={`p-2 rounded text-sm mb-4 ${p.status==='waiting_owner' ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300'}`}>{p.status==='waiting_owner' ? (<div className="font-bold flex items-center gap-1"><Icons.AlertCircle className="w-3 h-3"/> รอรับเงินจากผู้ฝาก</div>) : (<div>รูปแบบ: <b>กินคอมฯ {p.commission}%</b></div>)}{p.status==='waiting_owner' && (<div className="text-xs mt-1 opacity-80">ลูกค้าจ่ายแล้ว: {p.pendingAmount?.toLocaleString()}</div>)}</div>) : (<div className="bg-red-50 dark:bg-red-900/20 p-3 rounded text-sm mb-4 text-red-700 dark:text-red-300"><div className="font-bold mb-2">รูปแบบ: รับเต็มจำนวน</div><div className="flex justify-between text-xs mb-1"><span>จ่ายแล้ว: {(p.paidAmount || 0).toLocaleString()}</span><span>คงเหลือ: {(p.price - (p.paidAmount || 0)).toLocaleString()}</span></div></div>)}</div><div className="flex gap-2 mt-auto"><Button onClick={() => setInstallmentPayModal({ show: true, partner: p, amount: '' })} variant={p.status==='waiting_owner' ? 'warning' : 'primary'} className={`flex-1 text-sm ${p.status==='waiting_owner' ? '' : p.type === 'internal' ? 'bg-red-600 hover:bg-red-700' : 'bg-purple-600 hover:bg-purple-700'}`}>{p.status==='waiting_owner' ? 'รับเงินจากผู้ฝาก' : 'รับเงิน'}</Button><Button variant="outline" onClick={() => confirmAction('ลบรายการ', 'ยืนยันการลบรายการนี้?', () => setPartners(partners.filter(x => x.id !== p.id)))} className="px-3"><Icons.Trash2 className="w-4 h-4"/></Button></div></Card>))}</div>)}
                    {installmentViewMode === 'add_ext' && (<Card className="p-6 max-w-lg mx-auto"><h3 className="text-xl font-bold mb-4 text-purple-700 dark:text-purple-400 flex items-center gap-2"><Icons.Plus/> เพิ่มเครื่องนอก</h3><div className="space-y-3"><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="ชื่อร้าน/เจ้าของ" value={extForm.shop} onChange={e => setExtForm({...extForm, shop: e.target.value})} /><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="รุ่นสินค้า" value={extForm.model} onChange={e => setExtForm({...extForm, model: e.target.value})} /><div className="grid grid-cols-2 gap-2"><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" type="number" placeholder="ราคาปล่อย" value={extForm.price} onChange={e => setExtForm({...extForm, price: e.target.value})} /><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" type="number" placeholder="ต้นทุน" value={extForm.cost} onChange={e => setExtForm({...extForm, cost: e.target.value})} /></div><div className="border dark:border-slate-600 p-3 rounded-lg bg-slate-50 dark:bg-slate-750"><label className="block text-sm font-bold mb-2 dark:text-slate-300">รูปแบบการรับเงิน</label><div className="flex gap-4 mb-2 dark:text-slate-300"><label className="flex items-center gap-2"><input type="radio" name="ext_mode" checked={extForm.mode === 'full'} onChange={() => setExtForm({...extForm, mode: 'full'})} /> รับเต็มจำนวน</label><label className="flex items-center gap-2"><input type="radio" name="ext_mode" checked={extForm.mode === 'commission'} onChange={() => setExtForm({...extForm, mode: 'commission'})} /> กินคอมมิชชั่น (%)</label></div>{extForm.mode === 'commission' && (<input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" type="number" placeholder="ระบุ % คอมมิชชั่น" value={extForm.commission} onChange={e => setExtForm({...extForm, commission: e.target.value})} />)}</div><div className="flex gap-2 pt-4"><Button onClick={() => setInstallmentViewMode('list')} variant="secondary" className="flex-1">ยกเลิก</Button><Button onClick={handleAddExternal} className="flex-1 bg-purple-600 hover:bg-purple-700">บันทึก</Button></div></div></Card>)}
                    {installmentViewMode === 'import_stock' && (<Card className="p-6"><h3 className="text-xl font-bold mb-4 text-red-600 dark:text-red-400 flex items-center gap-2"><Icons.ArrowRightLeft/> เลือกสินค้าจากสต็อก</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-3">{inventory.filter(i => i.qty > 0).map(item => (<div key={item.id} onClick={() => setImportStockModal({ show: true, item, price: item.price, owner: 'ร้านเรา', mode: 'full', commission: '' })} className="border dark:border-slate-600 p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer"><div className="font-bold text-slate-800 dark:text-white">{item.name}</div><div className="text-sm text-slate-500 dark:text-slate-400 mt-1">ทุน: {item.cost} | เหลือ: {item.qty}</div></div>))}</div><Button onClick={() => setInstallmentViewMode('list')} variant="secondary" className="mt-6">กลับ</Button></Card>)}
                    {installmentPayModal.show && (<Modal title={installmentPayModal.partner?.revenueMode === 'commission' && installmentPayModal.partner?.status === 'waiting_owner' ? "รับเงินจากผู้ฝาก (ค่าคอม)" : "รับเงินจากลูกค้า"} onClose={() => setInstallmentPayModal({...installmentPayModal, show: false})}><input className="w-full p-3 border dark:border-slate-600 rounded mb-4 dark:bg-slate-700 dark:text-white" type="number" placeholder="จำนวนเงิน" value={installmentPayModal.amount} onChange={e => setInstallmentPayModal({...installmentPayModal, amount: e.target.value})} autoFocus /><Button onClick={confirmInstallmentPay} className="w-full">ยืนยัน</Button></Modal>)}
                    {importStockModal.show && (<Modal title="ดึงจากสต็อก" onClose={() => setImportStockModal({...importStockModal, show: false})}><div className="space-y-4"><div className="p-3 bg-slate-50 dark:bg-slate-700 rounded"><div className="font-bold dark:text-white">{importStockModal.item?.name}</div></div><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" type="number" placeholder="ราคาปล่อย" value={importStockModal.price} onChange={e => setImportStockModal({...importStockModal, price: e.target.value})} /><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="ชื่อเจ้าของ" value={importStockModal.owner} onChange={e => setImportStockModal({...importStockModal, owner: e.target.value})} /><div className="border dark:border-slate-600 p-3 rounded"><label className="block text-sm font-bold mb-2 dark:text-slate-300">รูปแบบ</label><div className="flex gap-4 dark:text-slate-300"><label><input type="radio" checked={importStockModal.mode === 'full'} onChange={() => setImportStockModal({...importStockModal, mode: 'full'})} /> รับเต็ม</label><label><input type="radio" checked={importStockModal.mode === 'commission'} onChange={() => setImportStockModal({...importStockModal, mode: 'commission'})} /> กินคอมฯ</label></div>{importStockModal.mode === 'commission' && <input className="w-full p-2 border dark:border-slate-600 rounded mt-2 dark:bg-slate-700 dark:text-white" type="number" placeholder="%" value={importStockModal.commission} onChange={e => setImportStockModal({...importStockModal, commission: e.target.value})} />}</div><Button onClick={confirmImportStock} className="w-full bg-red-600 hover:bg-red-700">ยืนยัน</Button></div></Modal>)}
                </div>
            );

            const renderReportView = () => {
                const showCostProfit = currentUser?.role === 'admin';
                const profitExcludingTopup = reportSummary.profit - reportSummary.topupProfit;
                
                return (
                <div className="max-w-[1400px] mx-auto p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold dark:text-white">รายงานยอดขาย</h2>
                        <div className="flex items-center gap-3">
                            <button onClick={() => { setShowDailySummaryModal(true); }} className="bg-orange-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-orange-600 flex items-center gap-2 font-medium transition-all active:scale-95"><Icons.FileText className="w-4 h-4" /> สรุปยอดปิดร้าน</button>
                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                                <button onClick={() => setReportTab('transactions')} className={`px-4 py-2 rounded-md text-sm transition-all ${reportTab === 'transactions' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300 font-bold' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700'}`}>รายการบิล</button>
                                <button onClick={() => setReportTab('daily_sum')} className={`px-4 py-2 rounded-md text-sm transition-all ${reportTab === 'daily_sum' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300 font-bold' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700'}`}>สรุปรายวัน</button>
                                <button onClick={() => setReportTab('monthly_sum')} className={`px-4 py-2 rounded-md text-sm transition-all ${reportTab === 'monthly_sum' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300 font-bold' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700'}`}>สรุปรายเดือน</button>
                                <button onClick={() => setReportTab('item_sum')} className={`px-4 py-2 rounded-md text-sm transition-all ${reportTab === 'item_sum' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300 font-bold' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700'}`}>สรุปสินค้า</button>
                            </div>
                        </div>
                    </div>

                    <div className={`grid gap-4 mb-8 ${showCostProfit ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4' : 'grid-cols-1 md:grid-cols-2'}`}>
                        {/* 1. Sales Card */}
                        <div className="p-5 bg-blue-600 dark:bg-blue-800 rounded-xl text-white shadow-sm flex flex-col justify-between h-full relative overflow-hidden group">
                            <div className="z-10">
                                <div className="text-blue-100 opacity-90 text-[11px] font-bold uppercase tracking-wider leading-tight">ยอดขายรวม</div>
                                <div className="text-3xl font-black truncate mt-1">฿{reportSummary.sales.toLocaleString()}</div>
                            </div>
                            <div className="z-10 mt-auto pt-2 border-t border-white/20">
                                <div className="flex justify-between items-center text-[10px] text-blue-50">
                                    <span>เงินสด: ฿{reportSummary.cashSales.toLocaleString()}</span>
                                    <span className="font-bold">เงินโอน: ฿{reportSummary.transferSales.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        {showCostProfit && (
                            <React.Fragment>
                                {/* 2. Cost Card */}
                                <div className="p-5 bg-orange-500 dark:bg-orange-700 rounded-xl text-white shadow-sm flex flex-col justify-between h-full">
                                    <div className="text-orange-100 opacity-80 text-sm font-medium">ยอดทุนรวม</div>
                                    <div className="text-3xl font-bold truncate">฿{reportSummary.cost.toLocaleString()}</div>
                                </div>

                                {/* 3. Combined Profit Card */}
                                <div className="p-5 bg-emerald-600 dark:bg-emerald-800 rounded-xl text-white shadow-sm flex flex-col justify-between h-full relative overflow-hidden group">
                                    <div className="z-10">
                                        <div className="text-emerald-100 opacity-90 text-[11px] font-bold uppercase tracking-wider leading-tight">กำไรสุทธิ (ไม่รวมเติมเงิน)</div>
                                        <div className="text-3xl font-black truncate mt-1">฿{profitExcludingTopup.toLocaleString()}</div>
                                    </div>
                                    <div className="z-10 mt-auto pt-2 border-t border-white/20">
                                        <div className="flex justify-between items-center text-[10px] text-emerald-50">
                                            <span>เติมเงิน: ฿{reportSummary.topupProfit.toLocaleString()}</span>
                                            <span className="font-bold">รวมทั้งสิ้น: ฿{reportSummary.profit.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                            </React.Fragment>
                        )}
                        
                        {/* 4. Bill Count Card */}
                        <Card className="p-5 bg-purple-600 dark:bg-purple-800 text-white border-none flex flex-col justify-between h-full">
                            <div className="text-purple-100 opacity-80 text-sm font-medium">จำนวนบิล</div>
                            <div className="text-3xl font-bold">{reportSummary.count.toLocaleString()}</div>
                        </Card>
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow border dark:border-slate-700 overflow-x-auto"><table className="w-full text-left text-sm"><thead><tr className="border-b dark:border-slate-700 text-slate-500 dark:text-slate-400"><th className="p-3">เวลา</th><th className="p-3">รายการ</th><th className="p-3 text-right">ยอดขาย</th>{showCostProfit && <th className="p-3 text-right">กำไร</th>}<th className="p-3 text-center">ดูบิล</th></tr></thead><tbody className="divide-y dark:divide-slate-700">{reportSummary.filteredSales.slice().reverse().map(sale => (<tr key={sale.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-3 text-slate-500 dark:text-slate-400">{new Date(sale.date).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td><td className="p-3 dark:text-slate-200">{sale.items.map((i, idx) => <div key={idx} className="truncate max-w-[200px]">{i.name} x{i.qty}</div>)}</td><td className="p-3 text-right font-medium"><div>฿{sale.total.toLocaleString()}</div><div className={`text-[10px] ${sale.paymentMethod === 'transfer' ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-green-600 dark:text-green-400'}`}>{sale.paymentMethod === 'transfer' ? 'โอนเงิน' : 'เงินสด'}</div></td>{showCostProfit && <td className="p-3 text-right text-green-600 dark:text-green-400 font-medium">+฿{sale.profit.toLocaleString()}</td>}<td className="p-3 text-center"><button onClick={() => setSaleDetailModal({ show: true, sale })} className="p-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-full"><Icons.FileText className="w-4 h-4"/></button></td></tr>))}</tbody></table></div>

                    {showDailySummaryModal && (
                        <Modal title="สรุปยอดปิดร้าน (Daily Close)" onClose={() => setShowDailySummaryModal(false)}>
                            <div className="space-y-6">
                                {/* PDF Content Area */}
                                <div id="daily-summary-content" className="bg-white dark:bg-slate-800 p-4 rounded-xl">
                                    <div className="text-center border-b dark:border-slate-700 pb-4">
                                        <div className="text-2xl font-bold text-slate-800 dark:text-white">สรุปยอดประจำวัน</div>
                                        <p className="text-slate-500 dark:text-slate-400 mt-1">วันที่ {new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    </div>
                                    <div className="space-y-3 mt-4">
                                        <div className="flex justify-between items-center text-slate-700 dark:text-slate-200 font-bold text-lg">
                                            <span>ยอดขายทั้งหมด ({todayStats.count} บิล)</span>
                                            <span>฿{todayStats.sales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex-1 border-l-4 border-green-500 bg-green-50 dark:bg-green-900/30 p-2 rounded">
                                                <div className="text-xs text-green-800 dark:text-green-300 font-bold">เงินสด</div>
                                                <div className="font-bold text-green-700 dark:text-green-400 text-lg">฿{todayStats.cash.toLocaleString()}</div>
                                            </div>
                                            <div className="flex-1 border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/30 p-2 rounded">
                                                <div className="text-xs text-blue-800 dark:text-blue-300 font-bold">โอนเงิน</div>
                                                <div className="font-bold text-blue-700 dark:text-blue-400 text-lg">฿{todayStats.transfer.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        <div className="bg-white dark:bg-slate-700 border dark:border-slate-600 rounded-lg p-3 text-sm mt-2 print-border">
                                            <div className="font-bold text-slate-700 dark:text-slate-200 mb-2 border-b dark:border-slate-600 pb-1">รายละเอียดสินค้าที่ขาย</div>
                                            <div className="space-y-3 max-h-60 overflow-y-auto">
                                                {Object.keys(todayStats.itemBreakdown).length > 0 ? (
                                                    Object.entries(todayStats.itemBreakdown)
                                                        .sort((a, b) => b[1].maxItemPrice - a[1].maxItemPrice) // Sort Categories by highest priced item
                                                        .map(([cat, categoryData]) => (
                                                        <div key={cat}>
                                                            <div className="font-bold text-xs text-slate-500 dark:text-slate-400 mb-1">{cat}</div>
                                                            {Object.values(categoryData.items).map((item, idx) => (
                                                                <div key={idx} className="flex justify-between text-slate-700 dark:text-slate-200 pl-2 mb-1">
                                                                    <div className="truncate pr-2 flex-1">
                                                                        <span className="text-[10px] text-slate-400 font-mono mr-1">[{item.productId || 'N/A'}]</span>
                                                                        <span>{item.name}</span>
                                                                        <span className="text-xs text-slate-400 ml-1">x{item.qty}</span>
                                                                    </div>
                                                                    <span className="font-medium whitespace-nowrap">฿{item.total.toLocaleString()}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ))
                                                ) : (<div className="text-slate-400 italic text-xs text-center">ไม่มีรายการขายในวันนี้</div>)}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border-2 border-dashed border-red-200 dark:border-red-900/50 print-border mt-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-sm font-bold text-red-600 dark:text-red-400">หัก: รายจ่ายประจำวัน</label>
                                            <span className="text-red-600 dark:text-red-400 font-bold">-฿{totalTodayExpenses.toLocaleString()}</span>
                                        </div>
                                        <div className="space-y-1">
                                            {todayExpenses.map(ex => (
                                                <div key={ex.id} className="flex justify-between items-center text-sm bg-white dark:bg-slate-800 p-2 rounded border dark:border-slate-700 group relative">
                                                    <span className="text-slate-700 dark:text-slate-300 pr-2 truncate flex-1">{ex.name}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold text-red-600 dark:text-red-400 whitespace-nowrap">-฿{ex.amount.toLocaleString()}</span>
                                                        <div className="flex gap-1 no-print">
                                                            <button onClick={() => handleEditExpense(ex)} className="p-1 text-blue-600 hover:bg-blue-50 rounded" title="แก้ไข">
                                                                <Icons.Edit className="w-3.5 h-3.5" />
                                                            </button>
                                                            <button onClick={() => handleDeleteExpense(ex.id)} className="p-1 text-red-500 hover:bg-red-50 rounded" title="ลบ">
                                                                <Icons.Trash2 className="w-3.5 h-3.5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {todayExpenses.length === 0 && <div className="text-center text-xs text-slate-400 italic py-1">ไม่มีรายจ่ายวันนี้</div>}
                                        </div>
                                    </div>
                                    <div className="space-y-2 pt-4 border-t-2 border-slate-800 dark:border-slate-600 mt-4">
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-lg dark:text-white">เงินสดสุทธิ (ส่งเจ้าของ)</span>
                                            <span className="font-bold text-3xl text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/30 px-2 rounded">฿{(todayStats.cash - totalTodayExpenses).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Expense Controls */}
                                <div className={`p-4 rounded-xl no-print transition-all ${expenseEditId ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-400' : 'bg-slate-100 dark:bg-slate-850'}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <label className="block text-sm font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">
                                            {expenseEditId ? '🚩 แก้ไขรายการรายจ่าย' : 'เพิ่มรายจ่ายใหม่'}
                                        </label>
                                        {expenseEditId && (
                                            <button onClick={() => { setExpenseEditId(null); setExpenseForm({name:'', amount:''}); }} className="text-xs text-blue-600 font-bold hover:underline">ยกเลิกแก้ไข</button>
                                        )}
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <input type="text" className="flex-1 p-2 border dark:border-slate-600 rounded text-sm min-w-0 dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="รายการรายจ่าย..." value={expenseForm.name} onChange={e => setExpenseForm({...expenseForm, name: e.target.value})} />
                                        <input type="number" className="w-24 p-2 border dark:border-slate-600 rounded text-sm text-right dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="บาท" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} />
                                        <button onClick={handleAddExpense} className={`p-2 rounded shrink-0 transition-colors ${expenseEditId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-500 hover:bg-red-600'} text-white`}>
                                            {expenseEditId ? <Icons.Check className="w-5 h-5"/> : <Icons.Plus className="w-5 h-5"/>}
                                        </button>
                                    </div>
                                </div>

                                <div className="pt-6 flex flex-col md:flex-row gap-2 no-print">
                                    <Button variant="secondary" className="flex-1" onClick={() => setShowDailySummaryModal(false)}>ปิดหน้าต่าง</Button>
                                    <Button className="flex-1 bg-slate-800 hover:bg-slate-900 text-white" onClick={() => window.print()}>
                                        <Icons.Printer className="w-4 h-4" /> พิมพ์ (Direct)
                                    </Button>
                                    <Button className="flex-1 bg-red-600 hover:bg-red-700 text-white" onClick={handleExportDailyPDF}>
                                        <Icons.Download className="w-4 h-4" /> ส่งออก PDF
                                    </Button>
                                </div>
                            </div>
                        </Modal>
                    )}
                </div>
                );
            };

            // --- MAIN RENDER ---
            return (
                <div className="flex h-screen bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans overflow-hidden transition-colors duration-300">
                    <aside className="hidden md:flex flex-col w-64 bg-white dark:bg-slate-800 border-r dark:border-slate-700 shadow-sm z-20">
                        <div className="p-6 border-b dark:border-slate-700"><h1 className="text-xl font-bold text-blue-600 dark:text-blue-400 flex items-center gap-2"><Icons.Smartphone className="text-blue-600 dark:text-blue-400"/> Mobile POS</h1></div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {['pos', 'services', 'installments', 'stock', 'report', 'users', 'audit'].map(tab => {
                                if ((tab==='users' && !hasPermission('users')) || (tab==='audit' && !hasPermission('audit')) || (!['users','audit'].includes(tab) && !hasPermission(tab))) return null;
                                return <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg capitalize ${activeTab === tab ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700/50'}`}>{tab==='pos' && <Icons.CreditCard className="w-5 h-5"/>}{tab==='services' && <Icons.Wrench className="w-5 h-5"/>}{tab==='installments' && <Icons.User className="w-5 h-5"/>}{tab==='stock' && <Icons.Package className="w-5 h-5"/>}{tab==='report' && <Icons.BarChart3 className="w-5 h-5"/>}{tab==='users' && <Icons.Users className="w-5 h-5"/>}{tab==='audit' && <Icons.History className="w-5 h-5"/>} <span className="capitalize">{PERMISSION_LABELS[tab]}</span></button>
                            })}
                        </nav>
                        <div className="p-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <button onClick={toggleTheme} className="p-1.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" title="เปลี่ยนธีม">{isDarkMode ? <Icons.Sun className="w-4 h-4"/> : <Icons.Moon className="w-4 h-4"/>}</button>
                                <div className="text-sm font-medium text-slate-700 dark:text-slate-200">{currentUser.name}</div>
                            </div>
                            <button onClick={handleLogout} className="text-red-500 hover:text-red-700 dark:hover:text-red-400 p-2"><Icons.LogOut className="w-5 h-5"/></button>
                        </div>
                    </aside>
                    <div className="md:hidden fixed top-0 w-full bg-white dark:bg-slate-800 border-b dark:border-slate-700 z-50 px-4 py-3 flex justify-between items-center shadow-sm"><h1 className="font-bold text-blue-600 dark:text-blue-400 flex items-center gap-2"><Icons.Smartphone className="w-5 h-5"/> Mobile POS</h1><button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 text-slate-700 dark:text-white"><Icons.Menu className="w-6 h-6"/></button></div>
                    {isMobileMenuOpen && (<div className="md:hidden fixed inset-0 bg-white dark:bg-slate-800 z-40 pt-16 px-4">{['pos','services','installments','stock','report', 'users', 'audit'].map(t => hasPermission(t) ? <button key={t} onClick={() => {setActiveTab(t); setIsMobileMenuOpen(false)}} className="block w-full text-left p-4 border-b dark:border-slate-700 capitalize text-slate-800 dark:text-white">{PERMISSION_LABELS[t]}</button> : null)}
                        <button onClick={handleLogout} className="block w-full text-left p-4 border-b dark:border-slate-700 text-red-600 dark:text-red-400">ออกจากระบบ</button><button onClick={() => setIsMobileMenuOpen(false)} className="absolute top-4 right-4 text-slate-800 dark:text-white"><Icons.X/></button></div>)}
                    <main className="flex-1 pt-16 md:pt-0 overflow-y-auto relative bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
                        {activeTab === 'stock' && renderStockView()}
                        {activeTab === 'pos' && renderPOSView()}
                        {activeTab === 'services' && renderServicesView()}
                        {activeTab === 'installments' && renderInstallmentView()}
                        {activeTab === 'report' && renderReportView()}
                        {activeTab === 'users' && renderUsersView()}
                        {activeTab === 'audit' && renderAuditLogView()}
                    </main>

                    {showCheckoutModal && (
                        <Modal title="ชำระเงิน" onClose={() => setShowCheckoutModal(false)}>
                            {checkoutStep === 'select' ? (
                                <React.Fragment>
                                    <div className="text-center py-5 bg-slate-50 dark:bg-slate-850 border dark:border-slate-700 rounded-xl mb-6">
                                        <div className="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">ยอดรวมที่ต้องชำระ</div>
                                        <div className="text-4xl font-bold text-blue-600 dark:text-blue-400">฿{calculateCartTotal().toLocaleString()}</div>
                                    </div>
                                    <div className="space-y-5">
                                        <div className="p-4 bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border dark:border-blue-900/30">
                                            <label className="text-xs font-bold text-blue-600 dark:text-blue-400 mb-2 block uppercase">ส่วนลดท้ายบิล</label>
                                            <div className="flex flex-col gap-3">
                                                <input type="number" className="w-full p-3 border rounded-lg dark:bg-slate-700 dark:text-white dark:border-slate-600" placeholder="ระบุส่วนลดเงินสด..." value={checkoutForm.discount} onChange={e => setCheckoutForm({...checkoutForm, discount: e.target.value})} />
                                                <input className="p-3 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" placeholder="ระบุเหตุผล (ถ้ามี)" value={checkoutForm.reason} onChange={e => setCheckoutForm({...checkoutForm, reason: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 pt-2">
                                            <Button className="py-4 text-lg bg-green-600 flex flex-col gap-1 h-auto" onClick={() => handleCheckout('cash', checkoutForm)}><Icons.CreditCard/><span className="font-bold">เงินสด</span></Button>
                                            <Button className="py-4 text-lg bg-blue-600 flex flex-col gap-1 h-auto" onClick={() => setCheckoutStep('transfer')}><Icons.QrCode/><span className="font-bold">โอนเงิน</span></Button>
                                        </div>
                                    </div>
                                </React.Fragment>
                            ) : (
                                <React.Fragment>
                                    <div className="text-center mb-4"><div className="text-lg font-bold dark:text-white">โอนเงิน</div><div className="text-3xl font-bold text-blue-600 dark:text-blue-400 my-2">฿{(Math.max(0, calculateCartTotal() - (parseNum(checkoutForm.discount)))).toLocaleString()}</div></div>
                                    <div className="bg-slate-50 dark:bg-slate-700 p-6 border rounded-lg mb-4 flex flex-col items-center">
                                        <div className="w-full space-y-2">
                                            <div className="flex justify-between p-2 border-b dark:border-slate-600"><span className="text-slate-500">ธนาคาร</span><span className="font-bold dark:text-white">กสิกรไทย</span></div>
                                            <div className="flex justify-between p-2"><span className="text-slate-500">เลขบัญชี</span><span className="font-bold dark:text-white">xxx-x-xxxxx-x</span></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pt-2"><Button variant="secondary" className="flex-1" onClick={() => setCheckoutStep('select')}>ย้อนกลับ</Button><Button className="flex-[2]" onClick={() => handleCheckout('transfer', checkoutForm)}>ยืนยันยอดเงินเข้า</Button></div>
                                </React.Fragment>
                            )}
                        </Modal>
                    )}

                    {discountModal.show && <Modal title="ส่วนลดรายชิ้น" onClose={() => setDiscountModal({...discountModal, show: false})}><input type="number" className="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-3 mb-3 rounded-lg outline-none" value={discountModal.amount} onChange={e => setDiscountModal({...discountModal, amount: e.target.value})} placeholder="จำนวนเงินส่วนลด" /><input className="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-3 mb-5 rounded-lg outline-none" value={discountModal.reason} onChange={e => setDiscountModal({...discountModal, reason: e.target.value})} placeholder="เหตุผลการลดราคา" /><Button onClick={saveDiscount} className="w-full py-3 rounded-lg">บันทึกส่วนลด</Button></Modal>}
                    {saleDetailModal.show && saleDetailModal.sale && (<Modal title="บิลการขาย" onClose={() => setSaleDetailModal({ show: false, sale: null })}><div className="space-y-4">
                        <div className="flex justify-between border-b dark:border-slate-700 pb-2"><div><div className="text-xs text-slate-500">เลขบิล</div><div className="font-mono font-bold dark:text-white">{saleDetailModal.sale.id}</div></div><div className="text-right text-xs text-slate-500">{new Date(saleDetailModal.sale.date).toLocaleString('th-TH')}</div></div>
                        <div className="space-y-2">{saleDetailModal.sale.items.map((item, idx) => (<div key={idx} className="flex justify-between text-sm"><div className="flex-1 pr-2"><div className="dark:text-white font-medium">{item.name}</div><div className="text-[10px] text-slate-400">x{item.qty} {item.itemDiscount > 0 ? `(ลด ${item.itemDiscount})` : ''}</div></div><div className="font-bold dark:text-white">฿{((item.price * item.qty) - (item.itemDiscount || 0)).toLocaleString()}</div></div>))}</div>
                        <div className="border-t dark:border-slate-700 pt-2 space-y-1"><div className="flex justify-between text-sm text-slate-500"><span>รวม</span><span>฿{saleDetailModal.sale.subtotal.toLocaleString()}</span></div>{saleDetailModal.sale.billDiscount > 0 && <div className="flex justify-between text-sm text-red-500"><span>ส่วนลดท้ายบิล</span><span>-฿{saleDetailModal.sale.billDiscount.toLocaleString()}</span></div>}<div className="flex justify-between text-xl font-bold text-blue-600 dark:text-blue-400"><span>สุทธิ</span><span>฿{saleDetailModal.sale.total.toLocaleString()}</span></div></div>
                        <Button className="w-full" onClick={() => window.print()}><Icons.Printer className="w-4 h-4"/> พิมพ์</Button>
                    </div></Modal>)}
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    {confirmData && <ConfirmModal title={confirmData.title} message={confirmData.message} onConfirm={confirmData.onConfirm} onCancel={() => setConfirmData(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MobileShopPOS />);
    </script>
</body>
</html>
